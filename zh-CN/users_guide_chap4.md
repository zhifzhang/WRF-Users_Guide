# 第四章 WRF初始化

## 目录

1. [简介](#Introduction)

2. [Ideal数据案例的初始化](#Initialization_for_Ideal)

3. [Real数据案例的初始化](#Initialization_for_Real)

<a id=Introduction></a>

## 简介

[WRF模型](http://wrf-model.org/ )有两大模拟类型可以生成数据，一个是ideal初始化，一个是利用real数据。理想化的模拟通常根据现有的一维或二维测深为WRF模型生成初始条件文件，并假设简化了分析地形。Real数据案例通常需要从WPS软件包中进行预处理，该软件包可为每个大气场和静态场提供适合模型所选网格分辨率的保真度。通过选择一个初始化选项而不是另一个初始化选项（ideal理想化还是real真实化），不会更改WRF模型可执行文件本身，但是WRF模型预处理器（real.exe和Ideal.exe程序）是根据用户的选择专门构建的。

real.exe和ideal.exe程序不要同时使用，这两个程序在WRF模型运行之前执行。

理想化模型和真实模型区别如下：

* 理想化模型——ideal.exe
	* 3d
		* em_b_wave：斜压波，100km
		* em_fire：地表火，50m
		* em_heldsuarez：带极性滤波的全局情况，625km
		* em_les：大涡模拟，100m
		* em_quarter_ss：超晶胞，2km
		* em_tropical_cyclone：飓风，15km
	* 2d
		* em_grav2d_x：重力流，密度流，100m
		* em_hill2d_x：flow over  a hill(未知) ,2km
		* em_seabreeze2d_x：水陆 ，2km，全物理结构 
		* em_squall2d_x：暴风雨线，阵风线，250m
		* em_squall2d_y：em_squall2d_x的转置
	* 1d
		* em_scm_xy：单柱模型，4km，全物理模型

* 真实模型——real.exe
	* em_real：从4到30km的例子，全物理模型

发出`./compile`语句时，将选择预测类型。选择不同的案例进行研究时，必须重新编译代码以为模型选择正确的初始化。例如，在配置了体系结构的设置（使用`./configure`命令）之后，如果用户发出命令`./compile em_real`，那么初始化程序将使用`module_initialize_real.F`（`./WRF/dyn_em/module_initialize_*.F`文件之一）作为目标模块。

对于ideal的初始化，可以使用文件的组合来构建可执行文件。对于em_fire、e m_heldsuarez、em_scm_xy和em_tropical_cyclone情况，存在单独的初始化文件。对于其他理想化情况，将使用文件`./WRF/dyn_em/module_initialize_ideal.F`。要注意WRF预测模型对这两种初始化程序都是一样的。对于每个初始化模块，执行步骤都是一样的，即：

* 计算位势和柱压的基态/参考剖面

* 计算位势和柱压的基态扰动

* 初始化气象变量：u，v，位温，水汽混合比

* 定义垂直坐标

* 将数据插值到模型的垂直坐标

* 初始化地图投影和物理表面的静态字段；对于许多理想情况，这些都是简化的初始化，例如将地图因子设置为1，将地形高程设置为0

* 在退出处理这些预处理活动的例程之前，如果用户要求热场使用潮湿的势能温度，则会计算出诊断变量

real.exe和ideal.exe程序共享很大一部分源代码，以处理以下任务：

* 从namelist中读取数据

* 给划定的区域分配空间，并在运行时指定模型变量

* 生成初始条件文件

real数据案例会进行一些其他处理： 

* 从WRF预处理系统（WPS）读取气象和静态输入数据 

* 准备要在模型中使用的土壤字段（通常垂直插值到指定陆地表面方案所需的层） 

* 检查以确认土壤类别、土地利用、陆地遮罩、土壤温度、海表温度是否彼此一致 

* 处理多个输入时间段以生成横向边界条件，除非处理全球预测，否则这是必需的 

* 3d边界数据（u、v、位温、蒸汽混合比、总地势）与总柱压耦合 

real.exe程序可以作为串行或分布式内存作业运行。由于ideal情况仅要求初始化运行单个时间段（不需要横向边界文件），可以快速处理，因此所有ideal.exe程序都应在单个处理器上运行。用于2D情况的Makefile将不允许用户使用分布式内存并行性来构建代码。对于大型二维情况，如果用户需要OpenMP，则必须在名称列表文件`namelist.input`的`domains`部分中设置变量`numtiles_x`和`numtiles_y`（`numtiles_y`必须设置为1，`numtiles_x`设置为OpenMP线程数）。

<a id=Initialization_for_Ideal></a>

## Ideal数据案例的初始化

ideal.exe可以使用户运行受控方案。一般来说，该运行程序只需要`namelist.input`和`input_sounding`作为输入文件。也有一些例外情况，例如对于斜波情况，需要使用二维二进制测深文件。程序输出`wrfinput_d01`文件，该文件通过wrf.exe执行程序进行读取，即wrf.exe得输入文件。在理想化模型中，不需要额外的数据，即使对于研究real数据情况的研究人员来说，理想化模拟也是确保不同结构和编译器下WRF模型运行正常的简单验证方法。





















理想化模拟中，除了“specified”情况，可以使用任意的边界条件，并且默认设置为复杂物理（微物理除外）。大多数都没有辐射、地表通量或摩擦效应（除了海风情况、LES和全球Held-Suarez）。理想化 情况最常用于动力学研究，再生收敛 解或其他已知解 以及理想化云模型 。

理想化情况下有带有或不带有 地形、初始热扰动的一维，二维，三维示例 ，namelist可以控制domain的大小，垂直层的数量，模型顶部高度，网格大小，时间步长，扩散和阻尼特性，边界条件和物理选择。很多已有的namelist设置 都已经在不同 情况目录下建立。

input_sounding文件（在合适的案例目录下）可以是任何级别的集合，这些级别至少可以达到名称列表中的模型顶部高度（ztop）。第一行包括表面压力（hPa），潜在温度（K）和水分混合比（g/kg）。每一行有 五个输入值：高度height（海平面为0），潜在温度（K），蒸汽混合比（g/kg），x向风分量（m/s），y向风 分量（m/s）。ideal.exe程序 从input_sounding文件进行数据插值，如果数据不足还可以进行相关论断得到。

理想化模型的机台探测是初始探测，去掉了水分，因此不用被单独定义。要注意，斜压波例子：不使用一维的探测输入，因为从input_jet文件读入的  是 初始的三维数组。也就是说对于斜压波例子而言，namelist.input文件不能改变水平或者垂直维度，因为已经在input_jet文件中定好了。

除了namelist控制选项或探测，修改必须使用Fortran代码。所谓的修改，包括改变地形，垂直层的分布，初始热汽泡的 性质，或者准备一个例子来使用更多的物理量，例如路表模型，Fortran代码位于./WRFV3/dyn_em/module_initialize_[case].F中，[case]指的是在 编译阶段选择的例程，如module_initialize_squall2d_x.F。要修改的子例程是init_domain_rk。要改变垂直层，只需要定义一维数组znw，包括全层（full levels）,k=1表明从1开始，k=kde表明是以0结尾。  要该改变地形，只有二维数组 ht需要定义，如果使用边界条件，需要确保其周期性。 要改变热扰动气泡，搜索字段“bubble”定位代码中需要改的位置。

每个理想化案例都为使用者提供了 一堆很好的默认示例。指定热气泡的方法在超晶胞案例中给出。在hill2d案例中，设置初始的三维数组时考虑地形因素，以便于后续例子可以符合任何一种地形案例。 飑线案例中的对称性示例检测修改的索引是否正确。全物理选项在seabreeze2d_x 案例中有相关解释。
 
可用的理想测试用例 
可获取的测试案例如下：

      1. 2-D  squall2d_x（test/em_squall2d_x）

使用凯斯勒微物理和300 m^2/s固定粘度的二维飑线（x，z）
y中使用的周期性条件，以便3D模型生成2D模拟。
v速度应为零，结果中y不应有变化。
      2. 2-D squall2d_y (test/em_squall2d_y)

和squall2d_x一样，只不过x要旋转为y
u速度应为零，结果中x不应有变化。
       3. 3-D quarter-circle shear supercell simulation (test/em_quarter_ss).四分之一圆剪切超晶胞模拟

产生左右移动的超晶胞
有关详细信息，请参阅测试目录中的README.quarter文件
       4. 2-D flow over a bell-shaped hill (x,z) (test/em_hill2d_x) 二维钟形山流 

半宽10km，网格长2km，高100m，流速10m/s，N=0.01/s，高30km，80层，辐射边界开阔，吸收上边界。
在线性静水状态下，垂直倾斜波的垂直波长约为6km。
       5. 3-D baroclinic waves (test/em_b_wave) 三维斜压波

f面上的气压不稳定急流u（y，z）。
南北对称，东西边界周期性。
100km网格尺寸，16km顶部，带4km阻尼层。
41x81点（x，y），64层。
        6. 2-D gravity current (test/em_grav2d_x)

测试用例在Straka et al，INT J NUMER METH FL 17（1）：1中描述-
1993年7月22日至15日。
查看测试目录中的README.grav2d_x文件。
         7. 2-D sea breeze (test/em_seabreeze_x)

2公里电网规模，20公里顶部，陆地/水域。
可与全物理、辐射、表面、边界层和陆地选项一起运行
         8. 3-D large eddy simulation (test/em_les)

100米网格大小，顶部2公里。
带焊剂的表层物理。
双周期
         9. 3-D Held-Suarez (test/em_heldsuarez)

全球域，x方向625公里，y方向556公里，顶部120公里。
辐射，极滤光片45以上
x方向周期，y方向极性边界条件
         10.  1-D single column model (test/em_scm_xy)

4公里电网规模，12公里顶部
全物理
双周期
          11. 3-D surface fire (test/em_fire)

地球科学模型开发讨论（GMDD）497-5452011，http://www.geosci-Model-dev-discus.net/4/497/2011/GMDD-4-497-2011.html
 50米，顶部4.5公里
 10:1次网格比率，无物理
开放边界
         12. 3-D tropical cyclone (test/em_tropical_cyclone)

Jordan，J METEOR 15，91-971958中描述的测试用例。
 15公里，顶部25公里
 f面（f=0.5e-5，约20N），SST=28C
完全物理，简单的辐射冷却，没有积云
双周期
         13. 3-D convective-radiative equilibrium (test/em_convrad)

1km网格尺寸，30km模型顶部
热带条件，小f，弱风，恒定海温
全物理
双周期

<a id=Initialization_for_Real></a>

## Real数据案例的初始化

实时数据WRF案例是将WPS提供的输入数据用real.exe程序运行。来自WPS的数据是最初由以前运行的外部分析或预测模型生成。原始数据大都是Grib格式，大多都是从某个国家气象代理的匿名ftp网址获得Griib数据。
例如，假设想要用WRF进行单层嵌套预测，有以下几个要求 ：
•	2000年1月24日12：00到1月25日12：00
•	原Grib数据间隔6小时
WPS将会生成下面所示的 粗网格文件，从 开始日期到结束日期，以6h为间隔。
•	met_em.d01.2000-01-24_12：00：00.nc 
•	met_em.d01.2000-01-24_18：00：00.nc 
•	met_em.d01.2000-01-25_00：00：00.nc 
•	met_em.d01.2000-01-25_06：00：00.nc 
•	met_em.d01.2000-01-25_12：00：00.nc 
使用“met”是为了标记这是WPS“metgrid.exe”的输出数据，也是real.exe程序的输入数据。“d01”指的是如果有嵌套区域，该数据指的是哪 一层嵌套。后面的日期就是时间，每个WPS的输出文件只有一个单独的 时间片来处理数据。文件的扩展名“.nc”表示WPS输出形式为nc文件，这个必须在real.exe层序中设置文件格式为 netCDF。对于局部区域的预测 ，“real.exe”必须处理多个时间段，以便模型可以使用横向边界文件。WRF的全球化预测只需要一个初始条件。
WPS包为WRF的real.exe程序提供数据 。
数据附在WRF IO API中。如果没有开发其他工具，就使用netCDF文件链接WPS包和real.exe文件
数据已经水平插值到每个变量的正确的格点，风场被正确旋转到WRFmodel地图投影。
WPS对三维气象数据的要求：u，v，温度temperature，相对湿度，位势高度
可供选择的三维水文气象资料可以在运行时提供到real程序中，但是这些场在粗网格横向边界文件中不会被使用。metgird输出文件中的场有：QR,QC,QS,QI,QG,QH,QNI（结合雨，云，雪，冰，霰，冰雹和数量浓度的比率），这些都是可用的场。
WPS输出的的三维土壤数据：土壤温度，土壤湿度，土壤水分（可选，取决于WRF模型的物理选择）
WPS输出的二维气象数据：海平面压力，表面压力，表面风速U,V，表面温度，表面相对湿度，输入高程
WPS输出的二维气象可选数据：海平面温度，实际雪深，水当量学深
针对物理表面的二维静态数据：地形高程，土地使用类型，土壤纹理类别，时间插值月数据，水陆标识 ，输入模型地形高程
二维静态数据投影：地图因子，科里奥利力，投影旋转，计算纬度
常量：区域大小，网格距离，日期
WPS数据可以是等压的，也可以是更广义的垂直坐标，其中每一列的压力都是无变化的
所有的三维气象数据（风、温度 、高度、湿度、压力）必须有相同的层数，变量的层数也必须完全相同。例如，不允许温度比高度的层数更多。同样的，对水平风向量不允许有额外的层。
真实数据测试用例：2000年1月24/12日至25/12 
实时数据测试案例：2000年1月24日12：00到1月25日12：00

测试数据可以从WRF download page.下载，在”WRF Model Test Data“列表下，选择 一月的数据。这个是74*61，30km区域，区域中心在美国东部。
确保成功built了代码（下载中提供了精细网格嵌套的初始数据，因此可以使用基本嵌套选项构建代码），./WRFV3/main/real.exe和./WRFV3/main/wrf.exe两个必须都存在。
在./WRFV3/test/em_real目录下，复制namelist


链接WPS文件（met_em*文件）到./WRFV3/test/em_real目录下
对单处理器而言，执行reral代码，输入命令
real.exe
该命令运行这个五段时间的小案例至少要一分钟

在运行了./real.exe之后，会生成文件“wrfinput_d01”和“wrfbdy_d01”，这些文件可以直接被WRF模型使用。
接下来输入命令
wrf.exe
运行程序，该命令会花费几分钟。

运行结束后会输出文件wrfout_d01:2000-01-24_12:00:00，3小时为间隔，共12小时。

最新版本的注意事项 
在WRF v4.0版本中，默认行为是包括湿势温度选项并包括混合垂直坐标。这两个选项使向后兼容变得困难。
•	湿势温度：use_theta_m = 0（off），1（on）
带有v3.8 的WRF系统引入了初始的湿势温度能力。在v3.8到v 3.9.1.1中，模型对所有有关theta的处理都由模型处理。这导致在主求解器例程中反复来回切换，因此变量grid％t_2的定义取决于例程中的位置。现在已正确移植了代码，以便将motheta选项合并到实际/理想预处理器中，并且grid％t_2变量的含义始终相同。使用v4.0，所有实际情况和理想情况都支持潮湿的潜在温度选项。因为v4.0代码假定输入变量与mota theta的名称列表设置一致，所以通常不使用较早版本的wrfinput_d0x和wrfbdy_d01文件。
如果用户具有较旧的输入数据（v4.0之前的版本），并且如果用户关闭了motheta 选项，则可以使用wrfinput_d0x和wrfbdy_d01 数据。
如果用户打开湿势温度选项，则只能使用新的wrfinput_d0x和wrfbdy_d01数据。
 
•	混合垂直坐标（HVC）：hybrid_opt = 0（关闭），2（打开）
从v3.9开始，WRF代码支持混合垂直坐标，但仅用于实际数据初始化和2d hill情况下的流程。使用v4.0，所有实际情况和理想情况都支持使用HVC。混合垂直坐标与潮湿theta选项同样适用于禁令。
如果用户具有不使用HVC的较旧的输入数据（v4.0之前的版本），并且用户关闭了WRF模型中的混合垂直坐标选项，则可以使用wrfinput_d0x和wrfbdy_d01数据。
如果用户打开了HVC选项，则只能使用新的wrfinput_d0x和wrfbdy_d01数据。
从v4.0开始，提供了一个新的名称列表选项（force_use_old_data = .TRUE。），以明确允许将旧的wrfinput_d0x和wrfbdy_d01文件引入WRF模型。 
 
设置模型垂直水平
用户可以使用名称列表选项eta_levels 明确定义完整的eta级别。给出了28级和35级的两个分布。级别数必须与分配的eta曲面数（e_vert）一致。用户可以选择仅请求级别数（使用e_vert），然后实际程序将计算值。从V4.0有吨WO方法可以与auto_levels_opt = 1（旧）或2（新）来选择。旧的计算假设先有几个已知层，然后生成等高间隔的级别，直到模型的顶部。新的方法具有surfa CE和上部伸展系数根据（dz_stretch_s和dz_stretch_u），以拉伸水平的log P，最多的点最大厚度（max_dz） ，和从厚度dzbot开始。厚度达到max_dz / 2时，拉伸从dzstretch_s过渡到dzstretch_u。 
 
对于dzbot = 50 m和max_dz = 1000 m的最小水平数作为
dzstretch和p_top的函数
dzstretch\ptop	50	30	20	10	1
1.1	44	47	50	54	67
1.2	32	35	37	41	54
1.3*	28	31	33	37	50

* 1.3厚度低于5公里时达到1公里（第13级）–可能不建议
1.2在7 km左右达到1 km厚度（19级）
1.1在约13 km处达到1 km厚度（第36级）
 
d zstretch = 1.1在最低1公里处具有12个水平，在10公里以下具有34个水平 
d zstretch = 1.2在最低的1 km中有9个等级，在10 km以下的地方有22个等级 
d zstretch = 1.3在最低的1 km中有8个等级，在10 km以下的地方有18个等级 
 
使用dzstretch_s和dzstretch_u时的最小级别数
dzstretch\ptop	50	30	20	10	1
1.2-1.02	53	58	62	67	81
1.2-1.04	46	49	51	55	68
1.2-1.06	41	44	47	50	63
1.3-1.1	33	36	39	43	56

为了避免在对流层上部具有最大厚度，在达到常数d（logp）之前，拉伸水平需要延伸到对流层顶上方。这可以通过使用足够低的dzstretch_u值（但低于〜1.02大）到达要做的对流层顶，同时拉伸速度不够快，以弥补递减率。
 
可以使用其他两个名称列表来增加灵活性：dzbot，这是全层之间的第一个模型层的厚度（默认值为50 m），以及max_dz，这是默认值1000 m允许的最大层厚度。
 
